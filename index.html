<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project Brief Assistant</title>

  <!-- Tailwind + React (single-file; no external CSS/JS of yours needed) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Small polish for chips & focus */
    .chip{transition:all .16s ease-in-out}
    .chip:focus-visible{outline:2px solid rgb(165,180,252); outline-offset:2px}
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useEffect, useRef} = React;

    /* ========= Question Banks ========= */
    const PRODUCT_BANK = [
      { id:"prod-desc",   section:"Product", text:"Product description",                     type:"text" },
      { id:"prod-specs",  section:"Product", text:"Key product specifications",              type:"text" },
      { id:"prod-qty",    section:"Product", text:"Quantity (units)",                        type:"text" },
      { id:"prod-target", section:"Product", text:"Target price (per unit or total)",        type:"text" },
      { id:"prod-date",   section:"Product", text:"Delivery date",                           type:"text" },
      { id:"prod-loc",    section:"Product", text:"Delivery location",                       type:"text" },
      { id:"prod-eco",    section:"Product", text:"Eco-friendly requirements?",              type:"single", options:["Yes","No","N/A"] },
    ];

    const PACKAGING_TYPES = [
      "Shopping Bag","Rigid Box","Foldable Box","Sleeve","Tube","Pouch","Tag / Label","Card / Insert","Sticker / Seal","Other"
    ];

    const P_BANK = {
      "Shopping Bag": [
        { id:"bag-material", text:"Bag material", type:"single", options:["Paper","Fabric","Recycled","Other","Skip"], section:"Packaging → Shopping Bag" },
        { id:"bag-handle",   text:"Handle type",  type:"single", options:["Ribbon","Rope","Die-cut","None","Skip"],    section:"Packaging → Shopping Bag" },
        { id:"bag-print",    text:"Printing",     type:"multi",  options:["1-color","Full-color","Emboss","Deboss","Foil","None","Skip"], section:"Packaging → Shopping Bag" },
        { id:"bag-finish",   text:"Finish",       type:"single", options:["Matte","Gloss","Laminated","None","Skip"], section:"Packaging → Shopping Bag" },
        { id:"bag-reinf",    text:"Reinforcement",type:"single", options:["Bottom","Top","Both","None","Skip"],       section:"Packaging → Shopping Bag" },
        { id:"bag-size",     text:"Approx size (L×W×H or WxHxD)", type:"text",  section:"Packaging → Shopping Bag" },
        { id:"bag-qty",      text:"Quantity",     type:"text",   section:"Packaging → Shopping Bag" },
        { id:"bag-target",   text:"Target price", type:"text",   section:"Packaging → Shopping Bag" },
        { id:"bag-ship",     text:"Delivery date & location", type:"text", section:"Packaging → Shopping Bag" },
      ],
      "Rigid Box": [
        { id:"rbox-style",  text:"Box style",   type:"single", options:["2-piece","Magnetic","Drawer","Slipcase","Skip"], section:"Packaging → Rigid Box" },
        { id:"rbox-insert", text:"Insert",      type:"single", options:["Foam","Paper","Pulp","None","Skip"],             section:"Packaging → Rigid Box" },
        { id:"rbox-print",  text:"Printing",    type:"multi",  options:["1-color","Full-color","Foil","Emboss","Deboss","Combo","Skip"], section:"Packaging → Rigid Box" },
        { id:"rbox-finish", text:"Finish",      type:"single", options:["Matte","Gloss","Laminated","Texture","Skip"],    section:"Packaging → Rigid Box" },
        { id:"rbox-addons", text:"Add-ons",     type:"multi",  options:["Ribbon closure","Magnet","Handle","None","Skip"], section:"Packaging → Rigid Box" },
        { id:"rbox-size",   text:"Approx size (L×W×H)", type:"text", section:"Packaging → Rigid Box" },
        { id:"rbox-qty",    text:"Quantity",    type:"text",   section:"Packaging → Rigid Box" },
        { id:"rbox-target", text:"Target price",type:"text",   section:"Packaging → Rigid Box" },
        { id:"rbox-ship",   text:"Delivery date & location", type:"text", section:"Packaging → Rigid Box" },
      ],
      "Foldable Box": [
        { id:"fbox-style",  text:"Foldable box style", type:"single", options:["Mailer","Crash lock","Auto-lock","Other","Skip"], section:"Packaging → Foldable Box" },
        { id:"fbox-print",  text:"Printing",           type:"multi",  options:["1-color","Full-color","Inside print","Foil","None","Skip"], section:"Packaging → Foldable Box" },
        { id:"fbox-finish", text:"Finish",             type:"single", options:["Matte","Gloss","Laminated","None","Skip"], section:"Packaging → Foldable Box" },
        { id:"fbox-size",   text:"Approx size",        type:"text",   section:"Packaging → Foldable Box" },
        { id:"fbox-qty",    text:"Quantity",           type:"text",   section:"Packaging → Foldable Box" },
        { id:"fbox-target", text:"Target price",       type:"text",   section:"Packaging → Foldable Box" },
        { id:"fbox-ship",   text:"Delivery date & location", type:"text", section:"Packaging → Foldable Box" },
      ],
      "Sleeve": [
        { id:"slv-mat",   text:"Sleeve material", type:"single", options:["Paperboard","Cardstock","Other","Skip"], section:"Packaging → Sleeve" },
        { id:"slv-print", text:"Printing",        type:"multi",  options:["1-color","Full-color","Foil","Emboss","None","Skip"], section:"Packaging → Sleeve" },
        { id:"slv-dims",  text:"Approx size / fit", type:"text", section:"Packaging → Sleeve" },
        { id:"slv-qty",   text:"Quantity",          type:"text", section:"Packaging → Sleeve" },
        { id:"slv-target",text:"Target price",      type:"text", section:"Packaging → Sleeve" },
        { id:"slv-ship",  text:"Delivery date & location", type:"text", section:"Packaging → Sleeve" },
      ],
      "Tube": [
        { id:"tube-type",  text:"Tube type",  type:"single", options:["Paper","Composite","Metal ends","Other","Skip"], section:"Packaging → Tube" },
        { id:"tube-print", text:"Printing",   type:"multi",  options:["1-color","Full-color","Foil","Emboss","None","Skip"], section:"Packaging → Tube" },
        { id:"tube-size",  text:"Approx size",type:"text",   section:"Packaging → Tube" },
        { id:"tube-qty",   text:"Quantity",   type:"text",   section:"Packaging → Tube" },
        { id:"tube-target",text:"Target price",type:"text",   section:"Packaging → Tube" },
        { id:"tube-ship",  text:"Delivery date & location", type:"text", section:"Packaging → Tube" },
      ],
      "Pouch": [
        { id:"pch-mat",   text:"Pouch material", type:"single", options:["Fabric","Recycled cotton","Nylon","Velvet","Other","Skip"], section:"Packaging → Pouch" },
        { id:"pch-close", text:"Closure",        type:"single", options:["Drawstring","Zipper","Fold-over","None","Skip"], section:"Packaging → Pouch" },
        { id:"pch-print", text:"Branding",       type:"multi",  options:["Silkscreen","Embroidery","Label","None","Skip"], section:"Packaging → Pouch" },
        { id:"pch-size",  text:"Approx size",    type:"text",   section:"Packaging → Pouch" },
        { id:"pch-qty",   text:"Quantity",       type:"text",   section:"Packaging → Pouch" },
        { id:"pch-target",text:"Target price",   type:"text",   section:"Packaging → Pouch" },
        { id:"pch-ship",  text:"Delivery date & location", type:"text", section:"Packaging → Pouch" },
      ],
      "Tag / Label": [
        { id:"tag-type",  text:"Type",     type:"single", options:["Hangtag","Woven label","Sticker label","Other","Skip"], section:"Packaging → Tag / Label" },
        { id:"tag-print", text:"Branding", type:"multi",  options:["1-color","Full-color","Foil","Emboss","None","Skip"], section:"Packaging → Tag / Label" },
        { id:"tag-size",  text:"Approx size", type:"text", section:"Packaging → Tag / Label" },
        { id:"tag-qty",   text:"Quantity",    type:"text", section:"Packaging → Tag / Label" },
        { id:"tag-target",text:"Target price",type:"text", section:"Packaging → Tag / Label" },
        { id:"tag-ship",  text:"Delivery date & location", type:"text", section:"Packaging → Tag / Label" },
      ],
      "Card / Insert": [
        { id:"card-stock", text:"Card stock", type:"single", options:["Uncoated","Coated","Textured","Other","Skip"], section:"Packaging → Card / Insert" },
        { id:"card-print", text:"Printing",   type:"multi",  options:["1-color","Full-color","Foil","Emboss","None","Skip"], section:"Packaging → Card / Insert" },
        { id:"card-size",  text:"Size",       type:"text",   section:"Packaging → Card / Insert" },
        { id:"card-qty",   text:"Quantity",   type:"text",   section:"Packaging → Card / Insert" },
        { id:"card-target",text:"Target price",type:"text",   section:"Packaging → Card / Insert" },
        { id:"card-ship",  text:"Delivery date & location", type:"text", section:"Packaging → Card / Insert" },
      ],
      "Sticker / Seal": [
        { id:"stk-type",  text:"Type",   type:"single", options:["Paper","Vinyl","Foil","Embossed","Other","Skip"], section:"Packaging → Sticker / Seal" },
        { id:"stk-shape", text:"Shape",  type:"single", options:["Round","Square","Custom","Skip"], section:"Packaging → Sticker / Seal" },
        { id:"stk-print", text:"Printing",type:"multi",  options:["1-color","Full-color","Foil","Emboss","None","Skip"], section:"Packaging → Sticker / Seal" },
        { id:"stk-size",  text:"Size",   type:"text",   section:"Packaging → Sticker / Seal" },
        { id:"stk-qty",   text:"Quantity", type:"text", section:"Packaging → Sticker / Seal" },
        { id:"stk-target",text:"Target price", type:"text", section:"Packaging → Sticker / Seal" },
        { id:"stk-ship",  text:"Delivery date & location", type:"text", section:"Packaging → Sticker / Seal" },
      ],
      "Other": [
        { id:"oth-desc", text:"Describe the packaging item(s)", type:"text", section:"Packaging → Other" },
        { id:"oth-qty",  text:"Quantity", type:"text", section:"Packaging → Other" },
        { id:"oth-target",text:"Target price", type:"text", section:"Packaging → Other" },
        { id:"oth-ship", text:"Delivery date & location", type:"text", section:"Packaging → Other" },
      ],
    };

    /* ========= UI Bits ========= */
    const STORAGE_KEY = "brief_tool_singlefile_v1";

    const Chip = ({selected, children, onClick}) => (
      <button
        onClick={onClick}
        className={
          "chip px-3 py-1.5 rounded-full border " +
          (selected
            ? "bg-indigo-600 text-white border-indigo-600 shadow"
            : "bg-white/70 backdrop-blur border-slate-200 hover:border-indigo-300")
        }>
        {children}
      </button>
    );

    const Pill = ({live}) => (
      <div className={"text-sm px-2.5 py-1 rounded-full border " + (live ? "text-red-600 border-red-200 bg-white" : "text-slate-500 border-slate-200 bg-white")}>
        {live ? "● Recording" : "◦ Mic Off"}
      </div>
    );

    function App(){
      // Flow state
      const [started, setStarted] = useState(false);
      const [branch, setBranch] = useState([]);      // ["Product","Packaging"]
      const [pkgTypes, setPkgTypes] = useState([]);  // multi
      const [queue, setQueue] = useState([]);        // array of q
      const [step, setStep] = useState(0);
      const [answers, setAnswers] = useState({});    // id -> {choices:[], notes:"", section:""}
      const [transcript, setTranscript] = useState("");
      const [complete, setComplete] = useState(false);

      // Speech
      const [speechSupported, setSpeechSupported] = useState(false);
      const [listening, setListening] = useState(false);
      const recognitionRef = useRef(null);
      const allowAutoRestartRef = useRef(true);

      // Asana modal
      const [asanaOpen, setAsanaOpen] = useState(false);
      const patRef = useRef(null), pidRef = useRef(null), taskRef = useRef(null);
      const [asanaMsg, setAsanaMsg] = useState("");

      // Restore
      useEffect(()=>{
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(raw){
            const s = JSON.parse(raw);
            setStarted(!!s.started);
            setBranch(s.branch||[]);
            setPkgTypes(s.pkgTypes||[]);
            setQueue(s.queue||[]);
            setStep(s.step||0);
            setAnswers(s.answers||{});
            setTranscript(s.transcript||"");
            setComplete(!!s.complete);
          }
        }catch{}
      },[]);
      // Persist
      useEffect(()=>{
        const snap = {started, branch, pkgTypes, queue, step, answers, transcript, complete};
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(snap)); }catch{}
      },[started, branch, pkgTypes, queue, step, answers, transcript, complete]);

      // Feature-detect SpeechRecognition (Safari often lacks it)
      useEffect(()=>{
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR){ setSpeechSupported(false); return; }
        const rec = new SR();
        rec.continuous = true; rec.interimResults = true; rec.lang = "en-US";
        recognitionRef.current = rec;
        rec.onresult = (evt)=>{
          let finalText = "";
          for(let i=evt.resultIndex;i<evt.results.length;i++){
            const t = evt.results[i][0].transcript;
            if(evt.results[i].isFinal) finalText += t + " ";
          }
          if(finalText) handleSpeech(finalText.trim());
        };
        rec.onerror = ()=>{};
        rec.onend = ()=>{
          if(listening && allowAutoRestartRef.current){
            try{ rec.start(); }catch{}
          }
        };
        setSpeechSupported(true);
      },[]);

      const startMic = ()=>{
        if(!recognitionRef.current) return;
        allowAutoRestartRef.current = true;
        try{ recognitionRef.current.start(); setListening(true); }catch{}
      };
      const stopMic = (userStop=false)=>{
        if(!recognitionRef.current) return;
        allowAutoRestartRef.current = !userStop;
        try{ recognitionRef.current.stop(); }catch{}
        if(userStop) setListening(false);
      };

      const handleSpeech = (text)=>{
        setTranscript(v => v + text + " ");
        const t = text.toLowerCase();
        if(/\b(stop recording)\b/.test(t)) { stopMic(true); return; }
        if(/\b(start recording)\b/.test(t)) { startMic(); return; }
        if(/\b(next|continue|next question)\b/.test(t)) { onContinue(); return; }
        if(/\b(back|previous|go back)\b/.test(t)) { onBack(); return; }
        if(/\b(skip)\b/.test(t)) { onSkip(); return; }
        if(/\b(not applicable|n a|n\.a\.|n\/a)\b/.test(t)) { onNA(); return; }

        const q = queue[step];
        if(!q) return;
        setAnswers(prev=>{
          const prior = prev[q.id] || {choices:[], notes:"", section:sectionFor(q)};
          return {...prev, [q.id]: {...prior, notes: (prior.notes ? prior.notes+" " : "") + text}};
        });
      };

      /* ===== Queue build ===== */
      const ENTRY_Q   = { id:"entry-branch", section:"Brief Type", type:"multi", text:"What kind of brief are you creating?", options:["Product","Packaging"] };
      const PKG_PICK  = { id:"pkg-types", section:"Packaging Type(s)", type:"multi", text:"Which type(s) of packaging are you requesting?", options:PACKAGING_TYPES };

      const sectionFor = (q)=>{
        if(q.id==="entry-branch") return "Brief Type";
        if(q.id==="pkg-types") return "Packaging Type(s)";
        return q.section || "Questions";
      };

      const begin = ()=>{
        setStarted(true);
        setBranch([]); setPkgTypes([]);
        setAnswers({}); setTranscript("");
        setComplete(false);
        setQueue([ENTRY_Q]);
        setStep(0);
        if(speechSupported) startMic();
      };

      // Recompute queue when branch / pkgTypes change
      useEffect(()=>{
        if(!started) return;
        let q = [ENTRY_Q];
        if(branch.includes("Packaging")){
          q.push(PKG_PICK);
          pkgTypes.forEach(name => (P_BANK[name]||[]).forEach(item => q.push(item)));
        }
        if(branch.includes("Product")){
          PRODUCT_BANK.forEach(item => q.push(item));
        }
        setQueue(q);
      },[branch, pkgTypes, started]);

      /* ===== Nav & record ===== */
      const recordAnswer = (q, {choiceLabel, notes, forceUnanswered} = {})=>{
        setAnswers(prev=>{
          const prior = prev[q.id] || {choices:[], notes:"", section:sectionFor(q)};
          let choices = [...prior.choices];
          let n = (notes !== undefined) ? notes : prior.notes;
          if(choiceLabel){ choices = [choiceLabel]; }
          if(forceUnanswered && choices.length===0 && !n){ n = "Unanswered"; }
          return {...prev, [q.id]: {choices, notes:n||"", section:sectionFor(q)}};
        });
      };

      const onContinue = ()=>{
        const q = queue[step];
        if(!q){ setComplete(true); return; }
        if(q.id==="entry-branch"){
          const sel = (answers[q.id]?.choices)||[];
          setBranch(Array.from(new Set(sel)));
        }
        if(q.id==="pkg-types"){
          const sel = (answers[q.id]?.choices)||[];
          setPkgTypes(sel);
        }
        if(!answers[q.id] || ((answers[q.id].choices||[]).length===0 && !(answers[q.id].notes||"").trim())){
          recordAnswer(q, {forceUnanswered:true});
        }
        const next = step+1;
        if(next>=queue.length) setComplete(true); else setStep(next);
      };
      const onBack = ()=> { if(step>0) setStep(step-1); };
      const onSkip = ()=> { const q=queue[step]; recordAnswer(q,{choiceLabel:"Skip"}); onContinue(); };
      const onNA   = ()=> { const q=queue[step]; recordAnswer(q,{choiceLabel:"Not applicable"}); onContinue(); };

      const toggleChoice = (label, kind)=>{
        const q = queue[step];
        setAnswers(prev=>{
          const prior = prev[q.id] || {choices:[], notes:"", section:sectionFor(q)};
          let choices = [...prior.choices];
          if(kind==="single"){
            choices = [label];
          } else {
            const i = choices.indexOf(label);
            if(i>=0) choices.splice(i,1); else choices.push(label);
          }
          return {...prev, [q.id]: {...prior, choices}};
        });
      };
      const setNotes = (v)=>{
        const q = queue[step];
        setAnswers(prev=>{
          const prior = prev[q.id] || {choices:[], notes:"", section:sectionFor(q)};
          return {...prev, [q.id]: {...prior, notes:v}};
        });
      };

      /* ===== Exports ===== */
      const exportJSON = ()=>{
        const payload = { startedAt: started ? new Date().toISOString():null, branch, pkgTypes, answers, transcript };
        const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
        const url = URL.createObjectURL(blob); const a = document.createElement("a");
        a.href=url; a.download=`brief_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
      };
      const exportPDF = ()=>{
        const payload = { branch, pkgTypes, answers, transcript };
        const w = window.open("", "_blank");
        const esc = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        w.document.write(`<pre style="white-space:pre-wrap;font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial,sans-serif">${esc(JSON.stringify(payload,null,2))}</pre>`);
        w.document.close(); w.focus(); w.print();
      };

      /* ===== Asana (client-only PAT) ===== */
      const openAsana = ()=> { setAsanaOpen(true); setAsanaMsg(""); };
      const sendAsana = async ()=>{
        const token = patRef.current.value.trim();
        const projectId = pidRef.current.value.trim();
        const name = (taskRef.current.value.trim() || "Brief");
        if(!token || !projectId){ setAsanaMsg("Token and Project ID required."); return; }
        sessionStorage.setItem("asana_pat", token);
        sessionStorage.setItem("asana_pid", projectId);
        const summary = { branch, pkgTypes, answers, transcript_tail: transcript.slice(-4000) };
        try{
          const resp = await fetch("https://app.asana.com/api/1.0/tasks", {
            method:"POST",
            headers:{ "Authorization":`Bearer ${token}`, "Content-Type":"application/json" },
            body: JSON.stringify({ projects:[projectId], name, notes:`LR Paris Brief\n\n${JSON.stringify(summary, null, 2)}` })
          });
          if(!resp.ok) throw new Error("HTTP " + resp.status);
          const data = await resp.json();
          setAsanaMsg(`Task created: ${data?.data?.gid || "OK"}`);
        }catch(e){ setAsanaMsg(`Asana error: ${e.message}`); }
      };

      const q = queue[step];
      const a = (q && answers[q.id]) || {choices:[], notes:""};

      return (
        <div className="max-w-5xl mx-auto p-6">
          {/* Always-visible Instructions + Mic */}
          <div className="bg-white/80 backdrop-blur border border-slate-200 rounded-2xl shadow-md p-6">
            <div className="flex items-center gap-3">
              <Pill live={listening && speechSupported}/>
              <button
                onClick={()=> (listening ? stopMic(true) : startMic())}
                disabled={!speechSupported}
                className={
                  "px-3 py-1.5 rounded-md border font-semibold " +
                  (speechSupported
                    ? (listening ? "border-red-300 text-red-600 bg-white" : "border-slate-300 text-slate-700 bg-white hover:border-indigo-300")
                    : "border-slate-200 text-slate-400 bg-slate-50 cursor-not-allowed")
                }
                aria-pressed={listening ? "true":"false"}>
                {speechSupported ? (listening ? "Stop Recording" : "Start Recording") : "Mic not available in this browser"}
              </button>
              <div className="ml-auto text-sm text-slate-500">
                Best in Chrome/Edge • If Safari disables mic, type answers below
              </div>
            </div>

            <div className="mt-4 grid md:grid-cols-2 gap-4">
              <div>
                <h2 className="text-sm uppercase tracking-wide text-slate-500 font-semibold">Instructions</h2>
                <ol className="mt-2 list-decimal pl-5 space-y-1 text-slate-700">
                  <li>Press <b>Start</b> to begin. Microphone runs continuously (browser permitting).</li>
                  <li>Answer by <b>voice</b> or by <b>clicking</b>. Recording never stops while you click.</li>
                  <li>First choose <b>Product</b> and/or <b>Packaging</b>. If Packaging, select all formats you need.</li>
                  <li>Only relevant follow-ups are asked. You can say voice commands at any time.</li>
                </ol>
              </div>
              <div>
                <h2 className="text-sm uppercase tracking-wide text-slate-500 font-semibold">Voice commands</h2>
                <div className="mt-2 flex flex-wrap gap-2">
                  {["next","continue","next question","back","previous","skip","not applicable","N A","start recording","stop recording"].map((t,i)=>(
                    <span key={i} className="px-2 py-1 rounded-md border bg-white text-slate-700 text-sm">{t}</span>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* Hero */}
          {!started && (
            <div className="mt-6 bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-3xl p-10 shadow-xl">
              <h1 className="text-3xl font-semibold">Start a new brief</h1>
              <p className="mt-2 text-white/90">Create a Product or Packaging brief with voice or taps. Autosaves locally. Export or send to Asana.</p>
              <div className="mt-5">
                <button onClick={begin} className="px-5 py-2.5 bg-white text-indigo-700 font-semibold rounded-md shadow hover:shadow-lg">
                  Start
                </button>
              </div>
            </div>
          )}

          {/* Question Card */}
          {started && !complete && q && (
            <div className="mt-6 bg-white rounded-2xl border border-slate-200 shadow p-6">
              <div className="flex items-end justify-between border-b pb-3">
                <div>
                  <div className="text-xs uppercase tracking-wide text-indigo-600 font-semibold">{sectionFor(q)}</div>
                  <h2 className="text-xl font-semibold mt-1">{q.text}</h2>
                </div>
                <div className="text-sm text-slate-500">Step {Math.min(step+1, queue.length)} of {queue.length}</div>
              </div>

              {(q.type==="single" || q.type==="multi") && (
                <div className="mt-4 flex flex-wrap gap-2">
                  {q.options.map(opt=>{
                    const selected = a.choices?.includes(opt);
                    return (
                      <Chip
                        key={opt}
                        selected={!!selected}
                        onClick={()=> toggleChoice(opt, q.type)}
                      >
                        {opt}
                      </Chip>
                    );
                  })}
                </div>
              )}

              {q.type==="text" && (
                <div className="mt-4">
                  <textarea
                    value={a.notes||""}
                    onChange={(e)=> setNotes(e.target.value)}
                    placeholder="Speak… (if supported) or type here."
                    className="w-full min-h-[120px] p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-300"
                  />
                </div>
              )}

              <div className="mt-5 flex items-center gap-2">
                <button onClick={()=>{ if(step>0) setStep(step-1); }} className="px-3 py-1.5 rounded-md border">Back</button>
                <div className="flex-1"></div>
                <button onClick={()=>{ const q=queue[step]; recordAnswer(q,{choiceLabel:"Skip"}); onContinue(); }} className="px-3 py-1.5 rounded-md border">Skip</button>
                <button onClick={()=>{ const q=queue[step]; recordAnswer(q,{choiceLabel:"Not applicable"}); onContinue(); }} className="px-3 py-1.5 rounded-md border">Not applicable</button>
                <button onClick={onContinue} className="px-4 py-1.5 rounded-md bg-indigo-600 text-white font-semibold shadow hover:shadow-md">Continue</button>
              </div>
            </div>
          )}

          {/* Complete */}
          {complete && (
            <div className="mt-6 bg-white rounded-2xl border border-slate-200 shadow p-6">
              <h2 className="text-xl font-semibold">Brief Complete</h2>
              <p className="text-slate-600 mt-1">Your selections and transcript are ready.</p>
              <div className="mt-4 flex flex-wrap gap-2">
                <button onClick={exportJSON} className="px-3 py-1.5 rounded-md bg-indigo-600 text-white">Export JSON</button>
                <button onClick={exportPDF} className="px-3 py-1.5 rounded-md border">Export PDF</button>
                <button onClick={()=> setAsanaOpen(true)} className="px-3 py-1.5 rounded-md border">Send to Asana (no server)</button>
                <button onClick={()=>{ localStorage.removeItem(STORAGE_KEY); setStarted(false); setComplete(false); }} className="px-3 py-1.5 rounded-md border">Start Over</button>
              </div>
            </div>
          )}

          {/* Asana Modal */}
          {asanaOpen && (
            <div className="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full">
                <div className="px-5 py-3 border-b">
                  <div className="font-semibold">Asana Quick Send</div>
                </div>
                <div className="p-5 space-y-3">
                  <div>
                    <label className="block text-sm text-slate-700">Personal Access Token</label>
                    <input ref={patRef} type="password" defaultValue={sessionStorage.getItem("asana_pat")||""} className="mt-1 w-full px-3 py-2 rounded-md border"/>
                  </div>
                  <div>
                    <label className="block text-sm text-slate-700">Project ID</label>
                    <input ref={pidRef} type="text" defaultValue={sessionStorage.getItem("asana_pid")||""} className="mt-1 w-full px-3 py-2 rounded-md border"/>
                  </div>
                  <div>
                    <label className="block text-sm text-slate-700">Task Name</label>
                    <input ref={taskRef} type="text" defaultValue={`Brief – ${new Date().toLocaleString()}`} className="mt-1 w-full px-3 py-2 rounded-md border"/>
                  </div>
                  <div className="text-sm text-slate-700">{asanaMsg}</div>
                </div>
                <div className="px-5 pb-5 flex justify-end gap-2">
                  <button onClick={()=> setAsanaOpen(false)} className="px-3 py-1.5 rounded-md border">Cancel</button>
                  <button onClick={async ()=>{
                    const token = patRef.current.value.trim();
                    const projectId = pidRef.current.value.trim();
                    const name = (taskRef.current.value.trim() || "Brief");
                    if(!token || !projectId){ setAsanaMsg("Token and Project ID required."); return; }
                    sessionStorage.setItem("asana_pat", token);
                    sessionStorage.setItem("asana_pid", projectId);
                    const summary = { branch, pkgTypes, answers, transcript_tail: transcript.slice(-4000) };
                    try{
                      const resp = await fetch("https://app.asana.com/api/1.0/tasks", {
                        method:"POST",
                        headers:{ "Authorization":`Bearer ${token}`, "Content-Type":"application/json" },
                        body: JSON.stringify({ projects:[projectId], name, notes:`LR Paris Brief\n\n${JSON.stringify(summary, null, 2)}` })
                      });
                      if(!resp.ok) throw new Error("HTTP " + resp.status);
                      const data = await resp.json();
                      setAsanaMsg(`Task created: ${data?.data?.gid || "OK"}`);
                    }catch(e){ setAsanaMsg(`Asana error: ${e.message}`); }
                  }} className="px-3 py-1.5 rounded-md bg-indigo-600 text-white">Create Task</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
